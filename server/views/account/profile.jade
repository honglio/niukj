extends ../layout

block content
  .container
    section.page-header
    section.row
      .col-sm-8.col-md-8
        .panel.panel-default
          .panel-heading
            h5.text-center= title
          .panel-body
            form.form-horizontal(action='/account/profile', method='POST')
              input(type='hidden', name='_csrf', value=_csrf)
              .form-group
                label.col-sm-2.control-label(for='email') Email
                .col-sm-10
                  input.form-control(type='email', name='email', id='email', value='#{user.email}')
              .form-group
                label.col-sm-2.control-label(for='name') 昵称
                .col-sm-10
                  input.form-control(type='text', name='name', id='name', value='#{user.profile.name}')
              .form-group
                label.col-sm-2.control-label(for='gender') 性别
                .col-sm-5
                  label.radio
                    input(type='radio', checked=user.profile.gender=='male', name='gender', value='male', data-toggle='radio')
                    span 男
                .col-sm-5
                  label.radio
                    input(type='radio', checked=user.profile.gender=='female', name='gender', value='female', data-toggle='radio')
                    span 女
              .form-group
                label.col-sm-2.control-label(for='location') 居住地
                .col-sm-10
                  input.form-control(type='text', name='location', id='location', value='#{user.profile.location}')
              .form-group
                label.col-sm-2.control-label(for='website') 个人网站
                .col-sm-10
                  input.form-control(type='text', name='website', id='website', value='#{user.profile.website}')
              .form-group
                label.col-sm-2.control-label(for='gravatar') 个人头像
                .col-sm-10
                  if (user.profile.picture.url)
                    //- = user.profile.picture
                    img(src="#{user.profile.picture.url}", class='profile', width='100', height='100')
                  else
                    #uploader
                      #filelist
                      #filePicker 点击上传头像
          footer.panel-footer.text-right.bg-light.lter
            .form-group.clearfix
              .col-sm-4
                a.btn.btn-primary(type='submit')
                  i.fa.fa-magnet
                  |  上传更新


      .col-sm-4.col-md-4
        .panel.panel-default
          .panel-heading
            h5.text-center 朋友圈
          .panel-body
            ul.profile-info-sections.text-center
              li
                .profile-stat
                  h3 #{user.contacts.followers.length}
                  span
                    a(href='/account/' + user.id + '/followers') 粉丝
              li
                .profile-stat
                  h3 #{user.contacts.followings.length}
                  span
                    a(href='/account/' + user.id + '/followings') 关注

append head
  link(rel="stylesheet", href='/css/webuploader.css', type='text/css')

append scripts
  script(type="text/javascript", src="/js/vendors/webuploader.min.js")
  script(type="text/javascript").

    if ( !WebUploader.Uploader.support() ) {
        alert( 'Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试升级 flash 播放器');
        throw new Error( 'WebUploader does not support the browser you are using.' );
    }
    // 初始化Web Uploader
    var uploader = WebUploader.create({
        // 选完文件后，是否自动上传。
        auto: true,

        // swf文件路径
        swf: '/js/vendors/Uploader.swf',

        // 文件接收服务端。
        server: '/account/uploadProfileImg',

        // 选择文件的按钮。可选。
        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
        pick: {id:'#filePicker', multiple:false},

        // 限制选择图片文件格式。
        accept: {
            title: 'Images',
            extensions: 'gif,jpg,jpeg,bmp,png',
            mimeTypes: 'image/*'
        }
    });

    var $list = $('#filelist');
    // 当有文件添加进来的时候
    uploader.on( 'fileQueued', function( file ) {
        var $li = $(
                '<div id="' + file.id + '" class="file-item thumbnail">' +
                    '<img class="profile">' +
                '</div>'
                ),
            $img = $li.find('img');


        // $list为容器jQuery实例
        $list.append( $li );

        // 创建缩略图
        // 如果为非图片文件，可以不用调用此方法。
        // thumbnailWidth x thumbnailHeight 为 100 x 100
        uploader.makeThumb( file, function( error, src ) {
            if ( error ) {
                $img.replaceWith('<span>不能预览</span>');
                return;
            }

            $img.attr( 'src', src );
        }, 100, 100 );
    });

    // 文件上传成功，给item添加成功class, 用样式标记上传成功。
    uploader.on( 'uploadSuccess', function( file ) {
        $( '#'+file.id ).addClass('upload-state-done');
    });

    // 文件上传失败，显示上传出错。
    uploader.on( 'uploadError', function( file ) {
        var $li = $( '#'+file.id ),
            $error = $li.find('div.error');

        // 避免重复创建
        if ( !$error.length ) {
            $error = $('<div class="error"></div>').appendTo( $li );
        }

        $error.text('上传失败');
    });
});
