extends ../layout

append head
  link(rel='stylesheet', href="/css/app/web-fonts.css", type='text/css')
  link(rel='stylesheet', href="/css/app/themes/backgroundClasses.css", type='text/css')
  link(rel='stylesheet', href="/css/app/impress.css", type='text/css')

block content
  - function round(v) {return Math2.round(v, 2);}
  .container-fluid
    .bg.impress-not-supported
      .page-header.fallback-message.text-center
        p 你的浏览器不支持此功能，请下载并更新浏览器。

      #impress
        div.id
          .hidden= article.id
        - each slide in article.slides
          .step(data-x='#{slide.x}', data-y='#{slide.y}')
            div(class="#{slide.background}" style="width:#{article.width}px; height:#{article.height}px;")
              - each component in slide.components
                - var top = round(component.y) + 'px';
                - var left = round(component.x) + 'px';
                - if (component.scale) {
                -   var width = round(component.scale.width) + 'px';
                -   var height = round(component.scale.height) + 'px';
                - }
                div(style="top:#{top}; left:#{left}; width:#{width}; height:#{height}; position: absolute; line-height: normal;")
                  - if (component.type == 'Image')
                    img(src='#{component.src}')
                  - if (component.type == 'TextBox')
                    div(style="font-family:#{component.face}; font-size:#{component.size}px; font-weight:#{component.weight}; font-style:#{component.style}; color: #{component.color}; text-decoration: #{component.decoration}; text-align: #{component.align}")= component.text
      a#arrowLeft.arrow &lt;
      a#arrowRight.arrow &gt;
  .container
    .present-footer
      .footer-left
        .meta.h4
          | 创建于 &nbsp;
          span.text-muted= formatDate(article.createdAt, 'YYYY年MM月DD日')
          | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          if (article.user)
            span 作者 - &nbsp;
            - var name = article.user.profile.name ? article.user.profile.name : article.user.email
            a(href="/account/"+article.user._id)= name
      .footer-right
        .loves
          i.fa.fa-heart.fa-2x &nbsp;#{article.love}
    .comments
      h3 评论
      - each comment in article.comments
        include ../comment/comment
      include ../comment/form
    section

append scripts
  script(type='text/javascript', src='/js/vendors/impress.js')
  script(type='text/javascript').

    if (!window.presStarted) {
      startPres(document, window);
      pres().init();
    }

    $('#arrowLeft').click(function(e){
      pres().prev();
      e.preventDefault();
    });

    $('#arrowRight').click(function(e){
      pres().next();
      e.preventDefault();
    });

    $('.navbar').addClass('hidden-sm hidden-xs');
    $('.comments').addClass('hidden-sm hidden-xs');

    var calculateHeight = function() {
      var slideHeight = $('.step').height();
      var slideWidth = $('.step').width();

      var matrixRegex = /matrix\((-?\d*\.?\d+),\s*0,\s*0,\s*(-?\d*\.?\d+),\s*0,\s*0\)/;
      var cssTransMatrix = $('#impress').css(window.browserPrefix + 'transform');
      var matches = cssTransMatrix.match(matrixRegex);
      // matches[1] will contain scaleX and matches[2] will contain scaleY.
      // if orientation is landscape
      if(window.innerHeight < window.innerWidth){
        $('.bg').height((slideHeight + 30) * matches[2]);
      } else { // if orientation is protrait
        $('.bg').height((slideHeight * 2) * matches[1]);
      }
    };

    $(window).resize(calculateHeight);

    $(function() {
      var $loveIcon = $('.loves i');
      var articleId = $('.id').text();
      $loveIcon.click(function(e){
        $loveIcon.toggleClass('getbigger');
        $.get('/articles/' + articleId + '/love', function( data ) {
          console.log(data);
          $loveIcon.text(' ' + data);
        });
      });
      calculateHeight();
    });
